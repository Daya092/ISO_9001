<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ISO 9001</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-certificate me-2"></i>
                ISO 9001
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="empresa-info">Cargando...</span>
                <a class="nav-link" href="seleccion-empresa.html">
                    <i class="fas fa-building me-1"></i>
                    Cambiar Empresa
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Gráficas de progreso (círculos) -->
        <div id="graficas-progreso">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                Progreso General
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <div class="progress-circle mb-3">
                                        <div class="progress-circle-inner" id="progress-general">
                                            <span class="progress-text">0%</span>
                                        </div>
                                    </div>
                                    <h6>Progreso General</h6>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="progress-circle mb-3">
                                        <div class="progress-circle-inner" id="progress-docs">
                                            <span class="progress-text">0%</span>
                                        </div>
                                    </div>
                                    <h6>Documentos</h6>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="progress-circle mb-3">
                                        <div class="progress-circle-inner" id="progress-videos">
                                            <span class="progress-text">0%</span>
                                        </div>
                                    </div>
                                    <h6>Videos</h6>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="progress-circle mb-3">
                                        <div class="progress-circle-inner" id="progress-audit">
                                            <span class="progress-text">0%</span>
                                        </div>
                                    </div>
                                    <h6>Auditoría</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Contenido del dashboard -->
        <div id="dashboard-content">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Desarrollo
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Panel de progreso y seguimiento</p>
                        <a href="#" class="btn btn-success" onclick="abrirModulo('desarrollo')">
                            <i class="fas fa-arrow-right me-2"></i>
                            Abrir Módulo
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Capacitación
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Gestión de documentos y videos</p>
                        <a href="#" class="btn btn-warning" onclick="abrirModulo('capacitacion')">
                            <i class="fas fa-arrow-right me-2"></i>
                            Abrir Módulo
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clipboard-check me-2"></i>
                            Auditoría
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Checklist y auditorías</p>
                        <a href="#" class="btn btn-info" onclick="abrirModulo('auditoria')">
                            <i class="fas fa-arrow-right me-2"></i>
                            Abrir Módulo
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedores ocultos para desarrollo -->
        <div id="desarrollo-extra" style="display:none;">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tasks me-2"></i>
                                Pendientes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="pendientes-container">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Historial Reciente
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="historial-container">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-folder-tree me-2"></i>
                                Capacitación por secciones (desplegables)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="accordionSecciones">
                                <!-- Secciones render -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let empresaId = null;
        let empresaInfo = null;

        // Obtener ID de empresa de la URL
        function obtenerEmpresaId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('empresa');
        }

        // Cargar información de la empresa
        async function cargarEmpresa() {
            empresaId = obtenerEmpresaId();
            
            if (!empresaId) {
                alert('No se especificó una empresa. Redirigiendo...');
                window.location.href = 'seleccion-empresa.html';
                return;
            }

            try {
                const response = await fetch(`/inicio/empresa/${empresaId}`);
                const data = await response.json();
                
                if (response.ok) {
                    empresaInfo = data.empresa;
                    document.getElementById('empresa-info').textContent = 
                        `${empresaInfo.razon_social} (${empresaInfo.nit})`;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error al cargar empresa:', error);
                alert('Error al cargar información de la empresa');
                window.location.href = 'seleccion-empresa.html';
            }
        }

        // Cargar datos del dashboard
        async function cargarDashboard() {
            if (!empresaId) return;

            try {
                const response = await fetch(`/desarrollo/dashboard/${empresaId}`);
                const data = await response.json();
                
                if (response.ok) {
                    actualizarProgreso(data.estadisticas);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error al cargar dashboard:', error);
            }
        }

        // Cargar pendientes
        async function cargarPendientes() {
            if (!empresaId) return;

            try {
                const response = await fetch(`/desarrollo/pendientes/${empresaId}`);
                const data = await response.json();
                
                if (response.ok) {
                    mostrarPendientes(data);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error al cargar pendientes:', error);
                document.getElementById('pendientes-container').innerHTML = 
                    '<div class="alert alert-danger">Error al cargar pendientes</div>';
            }
        }

        // Cargar historial
        async function cargarHistorial() {
            if (!empresaId) return;

            try {
                const response = await fetch(`/desarrollo/historial/${empresaId}`);
                const data = await response.json();
                
                if (response.ok) {
                    mostrarHistorial(data.historial);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error al cargar historial:', error);
                document.getElementById('historial-container').innerHTML = 
                    '<div class="alert alert-danger">Error al cargar historial</div>';
            }
        }

        // Actualizar círculos de progreso
        function actualizarProgreso(estadisticas) {
            actualizarCirculo('progress-general', estadisticas.general.porcentaje);
            actualizarCirculo('progress-docs', estadisticas.documentos.porcentaje);
            actualizarCirculo('progress-videos', estadisticas.videos.porcentaje);
            actualizarCirculo('progress-audit', estadisticas.auditoria.porcentaje);
        }

        function actualizarCirculo(id, porcentaje) {
            const elemento = document.getElementById(id);
            elemento.querySelector('.progress-text').textContent = `${porcentaje}%`;
            elemento.style.background = `conic-gradient(#007bff ${porcentaje * 3.6}deg, #e9ecef 0deg)`;
        }

        // Mostrar pendientes
        function mostrarPendientes(data) {
            const container = document.getElementById('pendientes-container');
            let html = '';

            if (data.documentos.length > 0) {
                html += '<h6>Documentos Pendientes:</h6><ul class="list-unstyled">';
                data.documentos.forEach(doc => {
                    html += `<li><i class="fas fa-file text-warning me-2"></i>${doc.nombre}</li>`;
                });
                html += '</ul>';
            }

            if (data.videos.length > 0) {
                html += '<h6>Videos Pendientes:</h6><ul class="list-unstyled">';
                data.videos.forEach(video => {
                    html += `<li><i class="fas fa-video text-warning me-2"></i>${video.nombre}</li>`;
                });
                html += '</ul>';
            }

            if (data.auditoria.length > 0) {
                html += '<h6>Auditoría Pendiente:</h6><ul class="list-unstyled">';
                // Ordenar por cláusula (de 10.3 a 4.0)
                data.auditoria.sort((a, b) => {
                    const numA = parseFloat(a.clausula);
                    const numB = parseFloat(b.clausula);
                    return numB - numA;
                });
                data.auditoria.forEach(item => {
                    html += `<li><i class="fas fa-clipboard text-warning me-2"></i>${item.clausula}: ${item.descripcion}</li>`;
                });
                html += '</ul>';
            }

            if (html === '') {
                html = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>¡Todo al día!</div>';
            }

            container.innerHTML = html;
        }

        // Mostrar historial
        function mostrarHistorial(historial) {
            const container = document.getElementById('historial-container');
            let html = '';

            if (historial.length > 0) {
                html = '<ul class="list-unstyled">';
                historial.forEach(item => {
                    const icono = item.tipo === 'documento' ? 'fas fa-file' : 
                                 item.tipo === 'video' ? 'fas fa-video' : 'fas fa-clipboard';
                    let fecha = '';
                    if (item.fecha) {
                        const d = new Date(item.fecha);
                        fecha = isNaN(d.getTime()) ? '' : d.toLocaleDateString();
                    }
                    html += `<li class="mb-2">
                        <i class="${icono} text-primary me-2"></i>
                        <strong>${item.nombre}</strong><br>
                        <small class="text-muted">${fecha}</small>
                    </li>`;
                });
                html += '</ul>';
            } else {
                html = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No hay historial disponible</div>';
            }

            container.innerHTML = html;
        }

        // Abrir módulos
        function abrirModulo(modulo) {
            if (!empresaId) return;
            switch(modulo) {
                case 'desarrollo':
                    // Ocultar solo las tarjetas de los módulos, mostrar progreso, pendientes e historial
                    document.querySelectorAll('.row.mb-4')[1].style.display = 'none'; // tarjetas módulos
                    document.getElementById('graficas-progreso').style.display = 'block';
                    document.getElementById('dashboard-content').style.display = 'block';
                    document.getElementById('desarrollo-extra').style.display = 'block';
                    cargarSeccionesCapacitacion();
                    // Agregar botón para volver a ver las tarjetas de módulos
                    if (!document.getElementById('btn-restaurar-modulos')) {
                        const btn = document.createElement('button');
                        btn.id = 'btn-restaurar-modulos';
                        btn.className = 'btn btn-outline-primary mt-4 mb-2';
                        btn.innerHTML = '<i class="fas fa-arrow-left me-2"></i>Ver opciones de módulos';
                        btn.onclick = function() {
                            document.querySelectorAll('.row.mb-4')[1].style.display = 'flex';
                            document.getElementById('desarrollo-extra').style.display = 'none';
                            btn.remove();
                        };
                        document.getElementById('graficas-progreso').appendChild(btn);
                    }
                    break;
                case 'capacitacion':
                    window.location.href = `capacitacion.html?empresa=${empresaId}`;
                    break;
                case 'auditoria':
                    window.location.href = `auditoria.html?empresa=${empresaId}`;
                    break;
                default:
                    alert(`Módulo ${modulo} no disponible`);
            }
        }

        // Inicializar dashboard
        async function inicializar() {
            // Mostrar ambos paneles al cargar
            document.getElementById('graficas-progreso').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'block';
            await cargarEmpresa();
            if (empresaId) {
                await cargarDashboard();
                await cargarPendientes();
                await cargarHistorial();
            }
        }

        async function cargarSeccionesCapacitacion() {
            try {
                const [resDocs, resVids] = await Promise.all([
                    fetch('/desarrollo/capacitacion-secciones'),
                    fetch(`/desarrollo/videos-secciones/${empresaId}`)
                ]);
                const dataDocs = await resDocs.json();
                const dataVids = await resVids.json();
                const sections = dataDocs.secciones || {};
                const vids = dataVids.secciones || {};
                const acc = document.getElementById('accordionSecciones');
                acc.innerHTML = '';

                const sectionOrder = [
                    { key: 'objetivos_especificos', title: 'Objetivos específicos' },
                    { key: 'ciclo_phva', title: 'Ciclo PHVA' },
                    { key: 'organizacion', title: 'Organización' },
                    { key: 'liderazgo', title: 'Liderazgo' },
                    { key: 'planificacion', title: 'Planificación' },
                    { key: 'apoyo', title: 'Apoyo' },
                    { key: 'operacion', title: 'Operación' },
                    { key: 'desempeno', title: 'Desempeño' }
                ];

                sectionOrder.forEach((sec, idx) => {
                    const items = sections[sec.key] || [];
                    const videos = vids[sec.key] || [];
                    const collapseId = 'collapse' + sec.key;
                    const card = document.createElement('div');
                    card.className = 'accordion-item';
                    const necesitaVideo = inferVideoNecesario(items) || videos.length > 0;
                    card.innerHTML = `
                        <h2 class="accordion-header" id="heading${sec.key}">
                            <button class="accordion-button ${idx === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                ${sec.title} <span class="badge bg-secondary ms-2">${items.length}</span>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#accordionSecciones">
                            <div class="accordion-body">
                                ${renderSectionBody(items, necesitaVideo, videos)}
                            </div>
                        </div>`;
                    acc.appendChild(card);
                });
            } catch (e) {
                console.error('Error al cargar secciones:', e);
            }
        }

        function inferVideoNecesario(items) {
            // Necesita video si predominan archivos tipo plantilla/matriz a completar
            // Palabras clave que indican necesidad de guía: plantilla, formato, matriz, requisitos a diligenciar
            const keywords = /(plantilla|formato|matriz|xlsx|xls)/;
            const nonGuide = /(manual|pol[ií]tica|gesti[oó]n\+del\+conocimiento|pdf|organigrama|mapa\+de\+procesos|ficha\+de\+procesos)/;
            const countGuide = items.filter(it => keywords.test(it.nombre.toLowerCase())).length;
            const countNon = items.filter(it => nonGuide.test(it.nombre.toLowerCase())).length;
            if (countGuide === 0 && countNon > 0) return false;
            return countGuide > 0;
        }

        function renderSectionBody(items, necesitaVideo, videos) {
            if (items.length === 0) return '<div class="text-muted">Sin archivos</div>';
            const list = items.map(it => `
                <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2">
                    <div class="me-3 text-truncate"><i class="fas fa-file me-2"></i><a href="${it.url}" target="_blank">${it.nombre}</a></div>
                    <div class="d-flex gap-2">
                        <a class="btn btn-sm btn-outline-primary" href="${it.url}" download>
                            <i class="fas fa-download me-1"></i>Descargar
                        </a>
                        <button class="btn btn-sm btn-success" onclick="abrirSubidaGenerica()">
                            <i class="fas fa-upload me-1"></i>Subir
                        </button>
                    </div>
                </div>
            `).join('');
            let videosHtml = '';
            if (necesitaVideo && Array.isArray(videos) && videos.length > 0) {
                videosHtml = `
                <div class="mt-3">
                    ${videos.map(v => {
                        const visto = v.visto === 1;
                        return `
                        <div class=\"border rounded p-2 mb-3\">
                            <div class=\"d-flex justify-content-between align-items-center mb-2\">
                                <div class=\"fw-semibold text-truncate\">${v.nombre}</div>
                                <span class=\"badge ${visto ? 'bg-success' : 'bg-warning text-dark'}\">${visto ? 'Visto' : 'Pendiente'}</span>
                            </div>
                            <div class=\"ratio ratio-16x9 mb-2\">
                                <iframe src=\"${v.video_url}\" allowfullscreen></iframe>
                            </div>
                            <button class=\"btn btn-sm ${visto ? 'btn-secondary' : 'btn-info'}\" onclick=\"marcarVideoVistoDesdeDesarrollo(${v.id})\">
                                <i class=\"fas ${visto ? 'fa-undo' : 'fa-eye'} me-1\"></i>
                                ${visto ? 'Desmarcar como visto' : 'Marcar video como visto'}
                            </button>
                        </div>`;
                    }).join('')}
                </div>`;
            }
            return list + videosHtml;
        }

        function abrirSubidaGenerica() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.pdf,.doc,.docx';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const form = new FormData();
                form.append('archivo', file);
                try {
                    const r = await fetch('/desarrollo/subir', { method: 'POST', body: form });
                    const j = await r.json();
                    if (j.success) {
                        alert('Archivo subido correctamente');
                    } else {
                        alert(j.error || 'Error al subir');
                    }
                } catch (err) {
                    alert('Error al subir');
                }
            };
            input.click();
        }

        async function marcarVideoVistoDesdeDesarrollo(documentoId) {
            try {
                const response = await fetch(`/capacitacion/video-visto/${documentoId}/${empresaId}`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    await cargarSeccionesCapacitacion();
                    await cargarDashboard();
                } else {
                    alert(data.error || 'Error al actualizar estado');
                }
            } catch (e) {
                alert('Error al actualizar estado del video');
            }
        }

        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', inicializar);
    </script>

    <style>
        .progress-circle {
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }
        
        .progress-circle-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(#007bff 0deg, #e9ecef 0deg);
            transition: all 0.3s ease;
        }
        
        .progress-text {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
        }
    </style>
</body>
</html>